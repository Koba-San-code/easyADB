# ADB Simple Tool

[![Language](https://img.shields.io/badge/Language-Batch-blue)](adb_tool_simple.bat)
[![Platform](https://img.shields.io/badge/Platform-Windows-green)](README.md)
[![License](https://img.shields.io/badge/License-As%20Is-orange)](README.md)

Минимальный консольный инструмент для повседневной работы с устройствами Android через ADB + (опционально) scrcpy. Включает панель управления пакетами с БД состояний и функцией отмены.

**Доступные языки:** [English](README.md) • [Русский](README_ru.md)

## Возможности

- **Управление устройствами**: Автоопределение и выбор Android устройств
- **Установка APK**: Установка одного APK или массовая установка всех APK в папке
- **Менеджер пакетов**: Расширенное управление пакетами с отслеживанием состояния и отменой
- **Передача файлов**: Push/Pull файлов и папок с логированием операций
- **Инструменты экрана**: Скриншоты и запись экрана (до 180 секунд)
- **Управление устройством**: Варианты перезагрузки (обычная/recovery/bootloader)
- **Разрешения**: Выдача/отзыв разрешений приложений
- **Беспроводной ADB**: Управление TCP/IP подключением с автоопределением IP
- **Трансляция экрана**: Интегрированный scrcpy с поддержкой аудио
- **Логирование операций**: Подробное логирование активности

## Состав

- `adb_tool_simple.bat` - Основной скрипт (один файл, без зависимостей)
- `adb.exe` - Локальный бинарник ADB (fallback на системный PATH)
- `scrcpy/` - Опциональный портативный scrcpy (fallback на глобальную установку)
- `adb_simple.log` - Файл логов операций
- `Packages_states.txt` - База данных пакетов: `имя|статус|тип`
- `packages_stack.txt` - Стек отмены для операций с пакетами
- `screens/` - Папка для скриншотов и записей экрана

## Главное меню

1. **Refresh / Pick device** - Выбрать первое доступное устройство
2. **Install ALL APK** - Массовая установка всех `*.apk` в текущей папке
3. **Install ONE APK** - Установка одного APK файла
4. **Package manager** - Вход в панель управления пакетами
5. **Push / Pull** - Передача файлов/папок с логированием
6. **Screenshot** - Снимок экрана устройства
7. **Screenrecord** - Запись экрана (до 180 секунд)
8. **Reboot menu** - Варианты перезагрузки (обычная/recovery/bootloader)
9. **Grant permission** - Выдать разрешение приложению (`pm grant`)
10. **Revoke permission** - Отозвать разрешение приложения (`pm revoke`)
11. **Wireless ADB** - Управление TCP/IP подключением
12. **Device info** - Показать версию SDK и статус root
13. **Cleanup temp** - Удалить временные файлы с устройства
14. **Screen stream** - Запустить scrcpy с поддержкой аудио
0. **Exit** - Выход из приложения

## Панель управления пакетами

Доступ через Главное меню → 4. Package manager

### Опции подменю:

1. **Show packages** - Показать пакеты с фильтрами:
   - **Фильтр подстроки**: Фильтр по имени пакета
   - **Фильтр статуса**: enabled / disabled / deleted / any
   - **Фильтр типа**: system / user / other / any
   - Показывает счетчики: всего, включено, отключено, удалено

2. **Disable package** - Отключить по номеру или точному имени
3. **Enable package** - Включить по номеру или точному имени
4. **Uninstall package** - Пометить как удаленный в базе данных
5. **Refresh statuses** - Полное пересканирование: обновление статусов/типов, добавление новых пакетов
6. **Export list** - Создать файлы `packages_export_<статус>.txt`
7. **Mass disable** - Массовое отключение из файла или встроенного списка
8. **Mass enable** - Массовое включение из файла или встроенного списка
9. **Undo last change** - Отменить последнюю операцию
0. **Back** - Вернуться в главное меню

### Формат базы данных пакетов

`Packages_states.txt` содержит строки:
```
package.name|enabled|system
package.name2|disabled|user
package.removed|deleted|other
```

**Статусы**: `enabled` / `disabled` / `deleted`  
**Типы**: `system` / `user` / `other`

### Стек отмены

`packages_stack.txt` хранит историю операций:
```
package.name|previous_status|new_status|action
```

Отмена возвращает последнюю операцию (enable↔disable). Для uninstall только восстанавливает статус в базе (требуется ручная переустановка).

## Быстрый старт

1. Подключите Android устройство и подтвердите RSA отпечаток
2. Запустите `adb_tool_simple.bat`
3. Выберите **1** (Refresh) для обнаружения устройства
4. Выберите **4** (Package manager) → **5** (Refresh statuses) для построения базы данных
5. Используйте нужные операции

## Типичные сценарии использования

- **Массовое управление системными приложениями**: Refresh → Show (фильтр system) → Export → Mass disable
- **Анализ обновлений прошивки**: Refresh → Show → сравнить новые пакеты
- **Быстрые скриншоты/запись**: Пункты меню 6-7
- **Восстановление ошибок**: Undo last change

## Логирование

Все операции записываются в `adb_simple.log` с временными метками:
```
[DD.MM.YYYY HH:MM:SS,ms] токен ...
```

**Ключевые токены**: `script_entry`, `selected=SERIAL`, `OK/FAIL install`, `push_OK/FAIL`, `screenshot`, `screenrecord`, `packages_refreshed`, `disable_OK/FAIL`, `undo`

## Технические детали

- **Архитектура**: Один .bat файл с функциями на основе меток
- **Работа с устройством**: Использует `ADB_CMD` после выбора устройства
- **Временные файлы**: `/data/local/tmp/shot.png`, `/data/local/tmp/rec.mp4`
- **Сортировка**: Использует команду Windows `sort` для списков пакетов
- **Обработка ошибок**: Корректное поведение при отсутствии подключенного устройства

## Интеграция scrcpy

Порядок поиска: `scrcpy\scrcpy.exe` → глобальный `scrcpy`  
Попытка с флагом `--audio`, fallback без аудио при неудаче.  
Для настройки флагов отредактируйте метку `:scrcpy_stream` в скрипте.

## Требования

- Windows (batch скрипт)
- ADB (включен или в PATH)
- Android устройство с включенной отладкой по USB
- Опционально: scrcpy для трансляции экрана

## Ограничения

- Нет автоматической переустановки после uninstall (только статус в базе данных)
- Нет поддержки split-APK (.apks)
- Стек отмены сохраняется между сессиями (при необходимости ручная очистка)

## Настройка

Для добавления новых функций:
1. Создайте метку `:my_action`
2. Добавьте в if-цепочку в `:main_menu`
3. Добавьте вызовы логирования
4. Обновите документацию

## Устранение неполадок

- **Пустое окно/мгновенный выход**: Проверьте `goto :__start` после инициализации
- **ADB не найден**: Поместите `adb.exe` в папку скрипта или добавьте в PATH
- **Нет пакетов/пустой список**: Проверьте соединение (`adb devices`), запустите Refresh statuses
- **scrcpy не запускается**: Протестируйте `scrcpy --version` в отдельном терминале

## Лицензия

Предоставляется "как есть". Используйте на свой риск.  
ADB и scrcpy имеют собственные лицензии.

---

Для дополнительной автоматизации (массовая переустановка, группы пакетов) архитектура может быть расширена - отправляйте запросы функций.
